import { chainConfigJsonMock } from '../../../../../tests/mocks/chain.config.json.mock';

jest.mock('../../../../../config/chains_config.json', () => {
  return chainConfigJsonMock;
});
import { Test, TestingModule } from '@nestjs/testing';
import { TransformService } from '../TransformService';
import { ChainConfigModule } from '../../../config/ChainConfigModule';
import { EventFromTransaction } from '../../../../external/solana_api/dto/response/get.events.from.transactions.response.dto';

describe('TransformService', () => {
  let service: TransformService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      imports: [ChainConfigModule],
      providers: [TransformService],
    }).compile();

    service = module.get<TransformService>(TransformService);
  });

  it('generateSubmissionFromSentEvent', () => {
    const event = {
      address: '0xB612f619EB0a90aEc3853396eE54D2aEc8cf7fD3',
      blockHash: '0xcd5a7c7ae6d3ee872396bf7c4d52256bd88b2d0597c68e9f7ddc36eca254fd6d',
      blockNumber: 29390593,
      logIndex: 613,
      removed: false,
      transactionHash: '0x83f2839d55b065956743d35064e36984b66354e21035f3b875744716466bdcc9',
      transactionIndex: 79,
      id: 'log_e821b7b9',
      returnValues: {
        '0': '0x0a1498bd02c8bb4353866bbac207ce99133f882a9ff1793218c3800b93d5cc9a',
        '1': '0xa64f418a067d562d9c177be545e9f12ab864534625b002205b154a71ddd08be3',
        '2': '988010000000000',
        '3': '0x7e52ec4bb4b72d0f8d638e19c192bf2007cdac5188c3ed66463a0c7201fe668f',
        '4': '94',
        '5': '7565164',
        '6': '1',
        '7': ['2000000000000000', '10000000000000', '1990000000000', true, true],
        '8': '0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000038d7ea4c680000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000207e52ec4bb4b72d0f8d638e19c192bf2007cdac5188c3ed66463a0c7201fe668f0000000000000000000000000000000000000000000000000000000000000000',
        '9': '0x774707E786b3fc316C95F6cE49237a42093919be',
        submissionId: '0x0a1498bd02c8bb4353866bbac207ce99133f882a9ff1793218c3800b93d5cc9a',
        debridgeId: '0xa64f418a067d562d9c177be545e9f12ab864534625b002205b154a71ddd08be3',
        amount: '988010000000000',
        receiver: '0x7e52ec4bb4b72d0f8d638e19c192bf2007cdac5188c3ed66463a0c7201fe668f',
        nonce: '94',
        chainIdTo: '7565164',
        referralCode: '1',
        feeParams: ['2000000000000000', '10000000000000', '1990000000000', true, true],
        autoParams:
          '0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000038d7ea4c680000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000207e52ec4bb4b72d0f8d638e19c192bf2007cdac5188c3ed66463a0c7201fe668f0000000000000000000000000000000000000000000000000000000000000000',
        nativeSender: '0x774707E786b3fc316C95F6cE49237a42093919be',
        chainIdFrom: 137,
      },
      event: 'Sent',
      signature: '0xe315721819a1f353fe56de404206bdd896ab5edc7822f1804a8c4c2c4788174c',
      raw: {
        data: '0x0a1498bd02c8bb4353866bbac207ce99133f882a9ff1793218c3800b93d5cc9a000000000000000000000000000000000000000000000000000382970115a4000000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000005e000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000071afd498d0000000000000000000000000000000000000000000000000000000009184e72a000000000000000000000000000000000000000000000000000000001cf553e3c000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000774707e786b3fc316c95f6ce49237a42093919be00000000000000000000000000000000000000000000000000000000000000207e52ec4bb4b72d0f8d638e19c192bf2007cdac5188c3ed66463a0c7201fe668f0000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000038d7ea4c680000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000207e52ec4bb4b72d0f8d638e19c192bf2007cdac5188c3ed66463a0c7201fe668f0000000000000000000000000000000000000000000000000000000000000000',
        topics: [
          '0xe315721819a1f353fe56de404206bdd896ab5edc7822f1804a8c4c2c4788174c',
          '0xa64f418a067d562d9c177be545e9f12ab864534625b002205b154a71ddd08be3',
          '0x0000000000000000000000000000000000000000000000000000000000736f6c',
        ],
      },
    };

    expect(service.generateSubmissionFromSentEvent(event)).toEqual({
      submissionId: '0x0a1498bd02c8bb4353866bbac207ce99133f882a9ff1793218c3800b93d5cc9a',
      txHash: '0x83f2839d55b065956743d35064e36984b66354e21035f3b875744716466bdcc9',
      chainFrom: 137,
      chainTo: '7565164',
      debridgeId: '0xa64f418a067d562d9c177be545e9f12ab864534625b002205b154a71ddd08be3',
      receiverAddr: '0x7e52ec4bb4b72d0f8d638e19c192bf2007cdac5188c3ed66463a0c7201fe668f',
      amount: '988010000000000',
      status: 1,
      ipfsStatus: 1,
      apiStatus: 1,
      assetsStatus: 1,
      rawEvent:
        '{"address":"0xB612f619EB0a90aEc3853396eE54D2aEc8cf7fD3","blockHash":"0xcd5a7c7ae6d3ee872396bf7c4d52256bd88b2d0597c68e9f7ddc36eca254fd6d","blockNumber":29390593,"logIndex":613,"removed":false,"transactionHash":"0x83f2839d55b065956743d35064e36984b66354e21035f3b875744716466bdcc9","transactionIndex":79,"id":"log_e821b7b9","returnValues":{"0":"0x0a1498bd02c8bb4353866bbac207ce99133f882a9ff1793218c3800b93d5cc9a","1":"0xa64f418a067d562d9c177be545e9f12ab864534625b002205b154a71ddd08be3","2":"988010000000000","3":"0x7e52ec4bb4b72d0f8d638e19c192bf2007cdac5188c3ed66463a0c7201fe668f","4":"94","5":"7565164","6":"1","7":["2000000000000000","10000000000000","1990000000000",true,true],"8":"0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000038d7ea4c680000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000207e52ec4bb4b72d0f8d638e19c192bf2007cdac5188c3ed66463a0c7201fe668f0000000000000000000000000000000000000000000000000000000000000000","9":"0x774707E786b3fc316C95F6cE49237a42093919be","submissionId":"0x0a1498bd02c8bb4353866bbac207ce99133f882a9ff1793218c3800b93d5cc9a","debridgeId":"0xa64f418a067d562d9c177be545e9f12ab864534625b002205b154a71ddd08be3","amount":"988010000000000","receiver":"0x7e52ec4bb4b72d0f8d638e19c192bf2007cdac5188c3ed66463a0c7201fe668f","nonce":"94","chainIdTo":"7565164","referralCode":"1","feeParams":["2000000000000000","10000000000000","1990000000000",true,true],"autoParams":"0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000038d7ea4c680000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000207e52ec4bb4b72d0f8d638e19c192bf2007cdac5188c3ed66463a0c7201fe668f0000000000000000000000000000000000000000000000000000000000000000","nativeSender":"0x774707E786b3fc316C95F6cE49237a42093919be","chainIdFrom":137},"event":"Sent","signature":"0xe315721819a1f353fe56de404206bdd896ab5edc7822f1804a8c4c2c4788174c","raw":{"data":"0x0a1498bd02c8bb4353866bbac207ce99133f882a9ff1793218c3800b93d5cc9a000000000000000000000000000000000000000000000000000382970115a4000000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000005e000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000071afd498d0000000000000000000000000000000000000000000000000000000009184e72a000000000000000000000000000000000000000000000000000000001cf553e3c000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000774707e786b3fc316c95f6ce49237a42093919be00000000000000000000000000000000000000000000000000000000000000207e52ec4bb4b72d0f8d638e19c192bf2007cdac5188c3ed66463a0c7201fe668f0000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000038d7ea4c680000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000207e52ec4bb4b72d0f8d638e19c192bf2007cdac5188c3ed66463a0c7201fe668f0000000000000000000000000000000000000000000000000000000000000000","topics":["0xe315721819a1f353fe56de404206bdd896ab5edc7822f1804a8c4c2c4788174c","0xa64f418a067d562d9c177be545e9f12ab864534625b002205b154a71ddd08be3","0x0000000000000000000000000000000000000000000000000000000000736f6c"]}}',
      blockNumber: 29390593,
      nonce: 94,
    });
  });

  it('generateSubmissionFromSolanaEvent', () => {
    const event = {
      type: 'staked',
      amount: '18834000',
      receiver: '0xb21dfea010e939f4bb0f0cb361352984a8c6ac0d',
      bridgeId: '0x15db45753160f76964dfa867510c9ede0ac87ac9ce24771de7efa0dab8251c1a',
      chainToId: 137,
      nonce: 24,
      transactionTimestamp: 1655412507,
      transactionHash: '4A9LBuKYsYG88RMC6qdxp2hHRcCSMZfRdYoRJPDinZaEcybMc7E4mzACihPmpG3HXHoRzJk1xAMzT2WFpKXCdhnY',
      slotNumber: 137802936,
      submissionId: '0x04d7baef204c472587c67e233d97a35085de91fc00d2cf5b7f1244020ccd2fa9',
      referralCode: 19,
      executionFee: '1146000',
      flags: '1',
      fallbackAddress: '0xb21dfea010e939f4bb0f0cb361352984a8c6ac0d',
      extCallShortcut: '0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470',
      nativeSender: '0x745c23dfc5aef34c755e48e1cfa77cc427e71a2cc83d976aea9c58a2fa1e63af',
      fixFee: '10000',
      transferFee: '20000',
      useAssetFee: false,
      lockedOrMintedAmount: '859354220',
      tokenTotalSupply: '0',
      receivedAmount: '20000000',
    } as EventFromTransaction;
    expect(service.generateSubmissionFromSolanaEvent(event)).toEqual({
      submissionId: '0x04d7baef204c472587c67e233d97a35085de91fc00d2cf5b7f1244020ccd2fa9',
      txHash: '4A9LBuKYsYG88RMC6qdxp2hHRcCSMZfRdYoRJPDinZaEcybMc7E4mzACihPmpG3HXHoRzJk1xAMzT2WFpKXCdhnY',
      chainFrom: 7565164,
      chainTo: 137,
      receiverAddr: '0xb21dfea010e939f4bb0f0cb361352984a8c6ac0d',
      amount: '18834000',
      rawEvent:
        '{"type":"staked","amount":"18834000","receiver":"0xb21dfea010e939f4bb0f0cb361352984a8c6ac0d","bridgeId":"0x15db45753160f76964dfa867510c9ede0ac87ac9ce24771de7efa0dab8251c1a","chainToId":137,"nonce":24,"transactionTimestamp":1655412507,"transactionHash":"4A9LBuKYsYG88RMC6qdxp2hHRcCSMZfRdYoRJPDinZaEcybMc7E4mzACihPmpG3HXHoRzJk1xAMzT2WFpKXCdhnY","slotNumber":137802936,"submissionId":"0x04d7baef204c472587c67e233d97a35085de91fc00d2cf5b7f1244020ccd2fa9","referralCode":19,"executionFee":"1146000","flags":"1","fallbackAddress":"0xb21dfea010e939f4bb0f0cb361352984a8c6ac0d","extCallShortcut":"0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470","nativeSender":"0x745c23dfc5aef34c755e48e1cfa77cc427e71a2cc83d976aea9c58a2fa1e63af","fixFee":"10000","transferFee":"20000","useAssetFee":false,"lockedOrMintedAmount":"859354220","tokenTotalSupply":"0","receivedAmount":"20000000"}',
      debridgeId: '0x15db45753160f76964dfa867510c9ede0ac87ac9ce24771de7efa0dab8251c1a',
      nonce: 24,
      blockNumber: 137802936,
      status: 1,
      ipfsStatus: 1,
      apiStatus: 1,
      assetsStatus: 1,
    });
  });
});
